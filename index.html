 <html>
 <body>
  <script src="http://localhost:8080/socket.io/socket.io.js"></script>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <!-- Latest compiled and minified CSS -->
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
 <!-- Latest compiled and minified JavaScript -->
 <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <div id ="infowell" class="well well-lg">
    <center><div>
  <b>Welcome to WorldSpace</b></div><div>
     <a href="" id="closeinfo">
     Close <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a></div>
     </center>
 </div>
 <div id="error"></div>
 	<div id="login">
 	  <div class="col-sm-4">
          <div id ="loginwell" class="well well-lg">
            <center>
                <div class="form-group">
                  <form role="form" id="login_usr" method="POST">
                  <label for="UserNameLogin">Username</label>
                  <input type="text" name="UserNameLogin" class="form-control" id="UserNamelogin" placeholder="Username"></input>
                  <br>
                  <label for="PassWordLogin">Password</label>
                  <input type="text" name="PassWordLogin" class="form-control" id="PassWordLogin" placeholder="Password"></input>
                  <br>
                 <input class="btn btn-success" type="submit" style="height:35px; width:65px" value="login" id="LoginBttn"></input><br><br>
            </form>
            </div>
            Need an Account? <a href="#" class="register_select">Register here </a>
         	</div>
         </div>
     </div>
  <div id="register">
    <div class="col-sm-4">
         <div id ="registerwell" class="well well-lg">
           <center>
               <div class="form-group">
                 <form role="form" id="register_usr" method="POST">
                 <label for="UserNameRegister">Username</label>
                 <input type="text" name = "UserNameLogin" class="form-control" id="UserNameRegister" placeholder="Username"></input>
                 <br>
                 <label for="PassWordRegister">Password</label>
                 <input type="text" name = "PassWordRegister" class="form-control" id="PassWordRegister" placeholder="Password"></input>
                 <br>
                 <label for="PassWordRegisterRetype">Retype Password</label>
                 <input type="text" name = "PassWordRegisterRetype" class="form-control" id="PassWordRegisterRetype" placeholder="Password"></input>
                 <br>
                 <label for="EmailRegister">Email</label>
                 <input type="text" name = "EmailRegister" class="form-control" id="EmailRegister" placeholder="Email"></input>
                 <br>
                <input class ="btn btn-success" type="submit" style="height:35px; width:75px" value="Register" id="RegisterBttn"></input><br><br>
            </form>
            </div>
            already have an account? <a href="" class="login_select">Login here </a>
          </div>
        </div>
    </div>
  <div id="post">
    <div class="col-sm-4">
       <div id ="registerwell" class="well well-lg">
         <div class="form-group">
          <!--<form role="form" id="post_form" method="POST"> -->
            <label for="AddressRegister">Type a location for your post</label>
              <input type="text" name = "AddressRegister" class="form-control" id="AddressRegister" placeholder="Location"></input><br>
              <input class="btn btn-success" type="submit" style="height:35px; width:190px" value="Find Address" id="typed_addr"></input><br><br>
              <input class="btn btn-success" type="submit" style="height:35px; width:190px" value="Or pick a spot on the map!" id="pickspot"></input><br><br>
          <!--  </form> -->
            </div>
          </div>
        </div>
    </div>
  <!-- Content Modal -->
<div class="modal fade" id="myModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="modal_post_title"></h4>
      </div>
      <div class="modal-body">
         <textarea class="form-control custom-control" rows="3" cols="30" style="resize:none" id="post_cntnt"></textarea>
      </div>
      <div class="modal-footer">
        <center>
        <button type="button" class="btn btn-success" id="make_post">Post</button>
        </center>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


  <div id="map-canvas" style="width: 100%; height: 100%"></div>
</div>
</body>
</html>
<style type="text/css">
#login {
  position: relative;
  z-index: 1; /* The z-index should be higher than Google Maps */
  opacity: .85; /* Set the opacity for a slightly transparent Google Form */
  width: 1000;
  top: 80 ;
  margin-left: 530 ;
  margin-right: 20 ;
}
#post {
  display: none;
  position: relative;
  z-index: 1; /* The z-index should be higher than Google Maps */
  opacity: .95; /* Set the opacity for a slightly transparent Google Form */
  width: 1000;
  top: 80 ;
  margin-left: 530 ;
  margin-right: 20 ;
}
#register {
  display: none;
  position: relative;
  z-index: 1; /* The z-index should be higher than Google Maps */
  opacity: .85; /* Set the opacity for a slightly transparent Google Form */
  width: 1000;
  top: 40 ;
  margin-left: 530 ;
  margin-right: 20 ;
}
#map-canvas {
  height: 100%;
  width: 100%;
  position:absolute;
  top: 0;
  left: 0;
  z-index: 0;
}
#error {
left: 50%;
 top: 40 ;
position: relative;
  z-index: 1;
}
#infowell {
   position: relative;
    z-index: 1; /* The z-index should be higher than Google Maps */
    opacity: .85;
}
</style>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false&key=AIzaSyAd_qUj056TQ8botUBBwAoRY8Mm5z4O8Lk&libraries=places"></script>
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script>
$(document).ready(function(){
  var markerExists = false;
  var marker;
  var map;
  var global_lat;
  var global_longi;
	var socket  = io.connect("http://localhost:8080");
  var gpp;
  var global_origin;
  var post_address;
  var user;
  var $error = $("#error");

socket.on("send_posts", function(dataArr){
  if(dataArr.length > 0){
      for(var i=0; i < dataArr.length; i++){
        var latit =  parseFloat(dataArr[4]);
        var longit =  parseFloat(dataArr[5]);
          var ltlng = new google.maps.LatLng(latit,longit);
          var title = dataArr[0];
          var content = dataArr[1];
           var marker = place_perm_marker(ltlng, title, content);
     
        }
      } 
    }); 
navigator.geolocation.watchPosition(function(position) {
console.log("loc enabled");
//enable user controls if location enabled
$("#UserNameLogin").prop("disabled", false);
$("#PassWordLogin").prop("disabled", false);
$("#LoginBttn").prop('disabled', false);
    },
    function (error) {
        if (error.code == error.PERMISSION_DENIED)
         console.log("location blocked");
         $error.html("You must allow your browsers geolocation");
         $("#LoginBttn").prop('disabled', true);
      });
if (navigator.geolocation){
  geolocate();
  navigator.geolocation.getCurrentPosition(showPosition);
};
$("#myModal").on("hidden.bs.modal", function(event){
  if(marker != null){
    marker.setMap(null);
    markerExists = false;
    gpp = null;
  }
  google.maps.event.clearListeners(map, 'click');
  var latlng = new google.maps.LatLng(global_lat,global_longi);
  map.setCenter(latlng);
  $("#AddressRegister").val("");
  $("#post").show();
});
socket.on("err_login", function(data){
 $("#error").html(data);
 console.log(data);
});
socket.on("reg_err", function(data){
$("#error").html(data);
console.log(data);
});
socket.on("logged_in", function(data){
$("#error").html(data);
$("#login").hide();
$("#post").show();
user = data;
console.log(data);
});
socket.on("account_created", function(data){
$("#error").html(data);
console.log(data);
});
$("#login_usr").submit(function(event){
event.preventDefault();
var usename = $("#UserNamelogin").val();
var password =$("#PassWordLogin").val();
console.log(usename);
socket.emit("login", usename, password);
});
$("#register_usr").submit(function(event){
  event.preventDefault();
var usename = $("#UserNameRegister").val();
var password =$("#PassWordRegister").val();
var password2 = $("#PassWordRegisterRetype").val();
var email = $("#EmailRegister").val();
if(password == password2){
socket.emit("register", usename, password, email);
} else {
  $("#error").html("<b>password mismatch</b>");
}
});
$(".login_select").click(function(event){
event.preventDefault();
$("#register").hide();
$("#login").show();
});
$(".register_select").click(function(event){
event.preventDefault();
$("#login").hide();
$("#register").show();
});
$("#pickspot").click(function(event){
   event.preventDefault();
   $("#post").hide();
   google.maps.event.addListener(map, 'click', function(event){
       placeMarker(event.latLng, "clicked");
    });
 });
$("#typed_addr").click(function(event){
  event.preventDefault();
  $("#post").hide();
  var addr = $("#AddressRegister").val();
  codeAddress(addr);
});
$("#make_post").click(function(event){

  var content = $("#post_cntnt").val();
  var post_lat = gpp.lat().toString().substr(0,8);
  var post_long = gpp.lng().toString().substr(0,8);
  socket.emit("submit_post", content, user, global_lat, global_longi, post_lat, post_long, post_address);
 $("#myModal").modal('hide');
  $("#post_cntnt").val("");
  if($("#AddressRegister").val().length > 0){
    $("#AddressRegister").val("");
  }
  $("#post").show();
});
socket.on("add_post_to_map", function(user, content, lat, longi, address){
  var post_lat = parseFloat(lat);
  var post_long = parseFloat(longi);
var post_position = new google.maps.LatLng(post_lat, post_long);
console.log(user);
console.log(content);
console.log(lat);
console.log(longi);
console.log(address);
  place_perm_marker(post_position, user, content);
});
function showPosition(position){
  if(position.coords == undefined){} else {
     global_lat = position.coords.latitude.toString().substr(0,8);
     global_longi = position.coords.longitude.toString().substr(0,8);
     console.log("lat " + global_lat);
     console.log("long " + global_longi);
    var mapOptions = {
      center : new google.maps.LatLng(global_lat,global_longi),
      zoom : 15,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
     map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
     socket.emit("map-loaded");
    var latlng = new google.maps.LatLng(global_lat,global_longi);
    global_origin = latlng;
    google.maps.event.addDomListener(window, 'load', showPosition);
  }
}
function place_perm_marker(position, title, content){
    var marker = new google.maps.Marker({
        position: position,
        map: map,
        title: title,
      });
     map.setCenter(marker.getPosition());
        var infowindow = new google.maps.InfoWindow({
           content: content
                });
        marker.addListener('click', function(){
            infowindow.open(map, marker);
        });
}
function placeMarker(location, called_from)
{
   if(markerExists){} else {
     marker = new google.maps.Marker({
        position: location,
        map: map,
    });
    map.setCenter(marker.getPosition());
    markerExists = true;
    gpp = marker.getPosition();
     if(marker.visible){
        $('#myModal').modal();
      console.log(marker.position);
      if(called_from == "addr"){
     //Do nothing ... YET!
      }
      if(called_from == "clicked"){
        codeLatLng(marker.position.G, marker.position.K, 2);
      }
     }
   }
}
function geolocate() {
          var input = document.getElementById('AddressRegister');
          var optns = {
              types: ['address']
          };
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
            var geolocation = new google.maps.LatLng(
                position.coords.latitude, position.coords.longitude);
                ac = new google.maps.places.Autocomplete(input, optns).setBounds(new google.maps.LatLngBounds(geolocation, geolocation));
            });
          }
        }
function codeAddress(addr)
{
  var geocoder;
  geocoder = new google.maps.Geocoder();
  geocoder.geocode( { 'address': addr}, function(results, status)
  {
    if (status == google.maps.GeocoderStatus.OK)
    {
      console.log(results[0].geometry.location);
      var latitude = results[0].geometry.location.G;
      var longitude = results[0].geometry.location.K;
      codeLatLng(latitude,longitude,1);
    }
  });
}

function codeLatLng(lat, lng, type)
{
   var geocoder;
  geocoder = new google.maps.Geocoder();
  var latlng = new google.maps.LatLng(lat, lng);
  if(type == 1){
  //Geocoder takes longitude and latitude and sets it to an adress.
  geocoder.geocode({'latLng': latlng}, function(results, status)
  {
if (status == google.maps.GeocoderStatus.OK)
    {
      if (results[1])
      {
        console.log(results[1].formatted_address);
        $("#modal_post_title").html("<b> Post at " + results[0].formatted_address + "</b>");
        post_address =  results[0].formatted_address;
        var town = results[1].formatted_address.split(",",1);
        console.log(town);
        placeMarker(latlng, "addr");
      }
    }
    else
    {
        alert("Geocoder failed due to: " + status);
    }
  });
  
} else if(type > 1){
  geocoder.geocode({'latLng': latlng}, function(results, status)
  {
    if (status == google.maps.GeocoderStatus.OK)
    {
        console.log(results[0].formatted_address);
        $("#modal_post_title").html("<b> Post at " + results[0].formatted_address + "</b>");
         post_address =  results[0].formatted_address;
    }
    else
    {
        alert("Geocoder failed due to: " + status);
    }
  });
}
}
// close document.ready
    });
</script>
